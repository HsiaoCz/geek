# 并发等待队列

设计一个并发队列需要考虑什么因素

1. 要不要考虑阻塞调用者的问题
   - 如果队列没有元素，应该阻塞拿数据的人
   - 如果队列满了，是不是要考虑阻塞放数据的人
   - 如果阻塞住了，要不要考虑只能阻塞一段时间，然后超时
2. 扩容：如果队列满了，或者容量快不够了，要不要扩容

   - 考虑大容量对 GC 的影响(对内存的影响)

3. 元素优先级问题
4. 线程安全问题
5. 持久化的问题：应用关闭的时候，持久化数据，重启就恢复
6. 要不要支持订阅模式
7. 是不是先到先得，尤其是阻塞的情况下
8. 考虑性能问题

## 功能需要

1. 用户可以控制最大容量

   - 防止占用很多内存，影响 GC
   - 要不要支持扩容的机制，比如说最大容量是 10000，初始容量是 100，后续会扩容或者缩容

2. 控制阻塞
   - 没有数据阻塞拿数据的人，并且要控制住超时，比如说最多阻塞 1s
   - 队列满了，阻塞住放数据的人，并且控制住超时
   - 考虑扩容缩容，怎么阻塞

## 非功能需求

1. 性能问题
2. 公平性

使用 context 来控制超时

1. context 天然支持，而且能够做到级联控制
2. context 本身承载链路元数据，所以 context 必不可少

1.54
