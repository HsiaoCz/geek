## Map的底层原理

### 1、map的核心结构

map的核心是两个结构体:hmap和bmap

创建map---->hmap{
    //字典的键值对个数
    //当使用len()获取map中的容量的时候，返回的就是这个值
    count
    //创建桶的个数为2的B次方
    //B用来决定创建多少个bmap
    B
    //当前map中桶的数组
    buckets
    //哈希因子，用于对key生成hash值
    //用于确定key应该放在哪儿
    hash0
    .....
}

其中buckets代表的桶数组，用于存储键值对
每个数组的值为bmap{
    //8个元素的数组，存储字典中每个key的哈希值的高8位
    tophash
    //8个元素的数组，存储字典key
    keys
    //8个元素的数组，存储字典的value
    values
    //指针，当前桶存不下的时候创建的溢出桶
    overflow
}

bmap真正存储键值对的单元，hmap统领这些bmap

### 2、map进行初始化

```go
// 初始化一个可容纳10个元素的map
info=map(map[string]string,10)
```

- 第一步：创建一个hmap结构体对象
- 第二步：生成一个哈希因子hash0并赋值刀hmap对象中(用于后续为key创建hash值)
- 第三步：根据hint=10，并根据算法规则来创建B,当前B应该为1

这个计算规则:
hint        B
0-8         0
9-13        1
14-26       2
.....

- 第四步：根据B去创建桶(bmap),并存放在buckets数组中，当前bmap的数量为2
  - 当B<4时，根据B创建的桶的个数规则为:2^B(标准桶)
  - 当B>4时，根据B创建的桶的个数的规则为:2^B+2^(B-4)（标准桶+溢出桶）

每个bmap中可以春初8个键值对，当不够存储时需要使用溢出桶，并将当前bmap中的overflow字段指向溢出桶的位置

### 3、写入数据

```go
info["name"]="lisi"
```

在map中写入数据时，内部的执行流程为:
- 第一步：结合哈希因子和键`name`生成hash值0100011010101101
- 第二步：获取哈希值的后B位，并根据后B位的值来确定此键值对存放到哪个桶中

这里其实是将哈希值和桶掩码进行与运算，将最终得到的值的后B位，假设为0，那么使用这个值作为桶数组的索引
将键值对存储到这个桶中

存储在这个桶的数据包括tophash,key,value分别写入到桶中的三个数组中